var E=Object.defineProperty,M=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var C=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var P=(r,t,e)=>t in r?E(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,s=(r,t)=>{for(var e in t||(t={}))A.call(t,e)&&P(r,e,t[e]);if(C)for(var e of C(t))Z.call(t,e)&&P(r,e,t[e]);return r},f=(r,t)=>M(r,V(t));import{ab as z,ac as _,N as x,ad as Q,ae as R,a5 as w,af as L,U as j,ag as U,ah as b,ai as D,E as d,aj as X,M as Y,ak as K,O as H,al as S,_ as m,$ as g,am as G,a0 as W,a3 as tt,an as et,D as rt}from"./vendor.b8b0b9ef.js";import{o as p}from"./utils.931ca8bb.js";import{l as ot,a as nt,n as st,s as it}from"./executeQueryJSON.b79a8498.js";import{t as $,S as at,p as ut}from"./query.c705041e.js";import{m as ct,n as lt}from"./featureConversionUtils.e458978f.js";import{v as dt}from"./normalizeUtils.7353462f.js";import{l as ht}from"./Task.b8d888f6.js";function ft(r){const t=r.toJSON();return t.attachmentTypes&&(t.attachmentTypes=t.attachmentTypes.join(",")),t.keywords&&(t.keywords=t.keywords.join(",")),t.globalIds&&(t.globalIds=t.globalIds.join(",")),t.objectIds&&(t.objectIds=t.objectIds.join(",")),t.size&&(t.size=t.size.join(",")),t}function yt(r,t){const e={};for(const o of r){const{parentObjectId:n,parentGlobalId:i,attachmentInfos:a}=o;for(const c of a){const{id:u}=c,l=z(_(`${t}/${n}/attachments/${u}`)),h=ot.fromJSON(c);h.set({url:l,parentObjectId:n,parentGlobalId:i}),e[n]?e[n].push(h):e[n]=[h]}}return e}function pt(r,t,e){let o={query:$(s(f(s({},r.query),{f:"json"}),ft(t)))};return e&&(o=f(s(s({},e),o),{query:s(s({},e.query),o.query)})),x(r.path+"/queryAttachments",o)}async function mt(r,t,e){const o=p(r);return pt(o,Q.from(t),s({},e)).then(n=>yt(n.data.attachmentGroups,o.path))}async function gt(r,t,e){const o=p(r);return at(o,R.from(t),s({},e)).then(n=>({count:n.data.count,extent:w.fromJSON(n.data.extent)}))}function Ft(r,t){return t}function I(r,t,e,o){switch(e){case 0:return F(r,t+o,0);case 1:return r.originPosition==="lowerLeft"?F(r,t+o,1):Ot(r,t+o,1)}}function v(r,t,e,o){return e===2?F(r,t,2):I(r,t,e,o)}function bt(r,t,e,o){return e===2?F(r,t,3):I(r,t,e,o)}function St(r,t,e,o){return e===3?F(r,t,3):v(r,t,e,o)}function F({translate:r,scale:t},e,o){return r[o]+e*t[o]}function Ot({translate:r,scale:t},e,o){return r[o]-e*t[o]}class jt{constructor(t){this.options=t,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"],this.previousCoordinate=[0,0],this.transform=null,this.applyTransform=Ft,this.lengths=[],this.currentLengthIndex=0,this.toAddInCurrentPath=0,this.vertexDimension=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,this.AttributesConstructor=function(){}}createFeatureResult(){return{fields:[],features:[]}}finishFeatureResult(t){if(this.options.applyTransform&&(t.transform=null),this.AttributesConstructor=function(){},this.coordinateBuffer=null,this.lengths.length=0,!t.hasZ)return;const e=L(t.geometryType,this.options.sourceSpatialReference,t.spatialReference);if(!j(e))for(const o of t.features)e(o.geometry)}createSpatialReference(){return{}}addField(t,e){t.fields.push(e);const o=t.fields.map(n=>n.name);this.AttributesConstructor=function(){for(const n of o)this[n]=null}}addFeature(t,e){t.features.push(e)}prepareFeatures(t){switch(this.transform=t.transform,this.options.applyTransform&&t.transform&&(this.applyTransform=this.deriveApplyTransform(t)),this.vertexDimension=2,t.hasZ&&this.vertexDimension++,t.hasM&&this.vertexDimension++,t.geometryType){case"esriGeometryPoint":this.addCoordinate=(e,o,n)=>this.addCoordinatePoint(e,o,n),this.createGeometry=e=>this.createPointGeometry(e);break;case"esriGeometryPolygon":this.addCoordinate=(e,o,n)=>this.addCoordinatePolygon(e,o,n),this.createGeometry=e=>this.createPolygonGeometry(e);break;case"esriGeometryPolyline":this.addCoordinate=(e,o,n)=>this.addCoordinatePolyline(e,o,n),this.createGeometry=e=>this.createPolylineGeometry(e);break;case"esriGeometryMultipoint":this.addCoordinate=(e,o,n)=>this.addCoordinateMultipoint(e,o,n),this.createGeometry=e=>this.createMultipointGeometry(e);break;default:U(t.geometryType)}}createFeature(){return this.lengths.length=0,this.currentLengthIndex=0,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0,this.coordinateBuffer=null,this.coordinateBufferPtr=0,{attributes:new this.AttributesConstructor}}allocateCoordinates(){}addLength(t,e,o){this.lengths.length===0&&(this.toAddInCurrentPath=e),this.lengths.push(e)}addQueryGeometry(t,e){const{queryGeometry:o,queryGeometryType:n}=e,i=ct(o.clone(),o,!1,!1,this.transform),a=lt(i,n,!1,!1);t.queryGeometryType=n,t.queryGeometry=s({},a)}createPointGeometry(t){const e={x:0,y:0,spatialReference:t.spatialReference};return t.hasZ&&(e.z=0),t.hasM&&(e.m=0),e}addCoordinatePoint(t,e,o){switch(e=this.applyTransform(this.transform,e,o,0),o){case 0:t.x=e;break;case 1:t.y=e;break;case 2:"z"in t?t.z=e:t.m=e;break;case 3:t.m=e}}transformPathLikeValue(t,e){let o=0;return e<=1&&(o=this.previousCoordinate[e],this.previousCoordinate[e]+=t),this.applyTransform(this.transform,t,e,o)}addCoordinatePolyline(t,e,o){this.dehydratedAddPointsCoordinate(t.paths,e,o)}addCoordinatePolygon(t,e,o){this.dehydratedAddPointsCoordinate(t.rings,e,o)}addCoordinateMultipoint(t,e,o){o===0&&t.points.push([]);const n=this.transformPathLikeValue(e,o);t.points[t.points.length-1].push(n)}createPolygonGeometry(t){return{rings:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}createPolylineGeometry(t){return{paths:[[]],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}createMultipointGeometry(t){return{points:[],spatialReference:t.spatialReference,hasZ:!!t.hasZ,hasM:!!t.hasM}}dehydratedAddPointsCoordinate(t,e,o){o===0&&this.toAddInCurrentPath--==0&&(t.push([]),this.toAddInCurrentPath=this.lengths[++this.currentLengthIndex]-1,this.previousCoordinate[0]=0,this.previousCoordinate[1]=0);const n=this.transformPathLikeValue(e,o),i=t[t.length-1];o===0&&(this.coordinateBufferPtr=0,this.coordinateBuffer=new Array(this.vertexDimension),i.push(this.coordinateBuffer)),this.coordinateBuffer[this.coordinateBufferPtr++]=n}deriveApplyTransform(t){const{hasZ:e,hasM:o}=t;return e&&o?St:e?v:o?bt:I}}async function xt(r,t,e){const o=p(r),n=s({},e),i=R.from(t),a=!i.quantizationParameters,{data:c}=await ut(o,i,new jt({sourceSpatialReference:i.sourceSpatialReference,applyTransform:a}),n);return c}function Rt(r,t){const e=r.toJSON();return e.objectIds&&(e.objectIds=e.objectIds.join(",")),e.orderByFields&&(e.orderByFields=e.orderByFields.join(",")),!e.outFields||t!=null&&t.returnCountOnly?delete e.outFields:e.outFields.indexOf("*")!==-1?e.outFields="*":e.outFields=e.outFields.join(","),e.outSpatialReference&&(e.outSR=e.outSR.wkid||JSON.stringify(e.outSR.toJSON()),delete e.outSpatialReference),e.dynamicDataSource&&(e.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e}async function Dt(r,t,e){const o=await T(r,t,e),n=o.data,i=n.geometryType,a=n.spatialReference,c={};for(const u of n.relatedRecordGroups){const l={fields:void 0,objectIdFieldName:void 0,geometryType:i,spatialReference:a,hasZ:!!n.hasZ,hasM:!!n.hasM,features:u.relatedRecords};if(u.objectId!=null)c[u.objectId]=l;else for(const h in u)u.hasOwnProperty(h)&&h!=="relatedRecords"&&(c[u[h]]=l)}return f(s({},o),{data:c})}async function $t(r,t,e){const o=await T(r,t,e,{returnCountOnly:!0}),n=o.data,i={};for(const a of n.relatedRecordGroups)a.objectId!=null&&(i[a.objectId]=a.count);return f(s({},o),{data:i})}async function T(r,t,e={},o){const n=$(s(s(f(s({},r.query),{f:"json"}),o),Rt(t,o)));return x(r.path+"/queryRelatedRecords",f(s({},e),{query:s(s({},e.query),n)}))}async function It(r,t,e){t=b.from(t);const o=p(r);return Dt(o,t,e).then(n=>{const i=n.data,a={};return Object.keys(i).forEach(c=>a[c]=D.fromJSON(i[c])),a})}async function Ct(r,t,e){t=b.from(t);const o=p(r);return $t(o,t,s({},e)).then(n=>n.data)}const q="Layer does not support extent calculation.";function Pt(r,t){var e,o;const n=r.geometry,i=r.toJSON(),a=i;if(d(n)&&(a.geometry=JSON.stringify(n),a.geometryType=Y(n),a.inSR=n.spatialReference.wkid||JSON.stringify(n.spatialReference)),(e=i.topFilter)!=null&&e.groupByFields&&(a.topFilter.groupByFields=i.topFilter.groupByFields.join(",")),(o=i.topFilter)!=null&&o.orderByFields&&(a.topFilter.orderByFields=i.topFilter.orderByFields.join(",")),i.topFilter&&(a.topFilter=JSON.stringify(a.topFilter)),i.objectIds&&(a.objectIds=i.objectIds.join(",")),i.orderByFields&&(a.orderByFields=i.orderByFields.join(",")),i.outFields&&!(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?i.outFields.indexOf("*")!==-1?a.outFields="*":a.outFields=i.outFields.join(","):delete a.outFields,i.outSR?a.outSR=i.outSR.wkid||JSON.stringify(i.outSR):n&&i.returnGeometry&&(a.outSR=a.inSR),i.returnGeometry&&delete i.returnGeometry,i.timeExtent){const c=i.timeExtent,{start:u,end:l}=c;u==null&&l==null||(a.time=u===l?u:`${u==null?"null":u},${l==null?"null":l}`),delete i.timeExtent}return a}async function qt(r,t,e,o){const n=await O(r,t,"json",o);return K(t,e,n.data),n}async function wt(r,t,e){return d(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):O(r,t,"json",e,{returnIdsOnly:!0})}async function Gt(r,t,e){return d(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):O(r,t,"json",e,{returnExtentOnly:!0,returnCountOnly:!0}).then(o=>{const n=o.data;if(n.hasOwnProperty("extent"))return o;if(n.features)throw new Error(q);if(n.hasOwnProperty("count"))throw new Error(q);return o})}function vt(r,t,e){return d(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):O(r,t,"json",e,{returnIdsOnly:!0,returnCountOnly:!0})}function O(r,t,e,o={},n={}){const i=typeof r=="string"?H(r):r,a=t.geometry?[t.geometry]:[];return o.responseType=e==="pbf"?"array-buffer":"json",dt(a,null,o).then(c=>{const u=c&&c[0];d(u)&&((t=t.clone()).geometry=u);const l=$(s(s(f(s({},i.query),{f:e}),n),Pt(t,n)));return x(X(i.path,"queryTopFeatures"),f(s({},o),{query:s(s({},l),o.query)}))})}async function Tt(r,t,e,o){const n=p(r),i=s({},o),{data:a}=await qt(n,S.from(t),e,i);return D.fromJSON(a)}async function Nt(r,t,e){const o=p(r);return(await wt(o,S.from(t),s({},e))).data.objectIds}async function Bt(r,t,e){const o=p(r),n=await Gt(o,S.from(t),s({},e));return{count:n.data.count,extent:w.fromJSON(n.data.extent)}}async function Jt(r,t,e){const o=p(r);return(await vt(o,S.from(t),s({},e))).data.count}let y=class extends ht{constructor(r){super(r),this.dynamicDataSource=null,this.fieldsIndex=null,this.format="json",this.gdbVersion=null,this.infoFor3D=null,this.sourceSpatialReference=null}execute(r,t){return this.executeJSON(r,t).then(e=>this.featureSetFromJSON(r,e,t))}async executeJSON(r,t){var e;const o=s(s({},this.requestOptions),t),n=this._normalizeQuery(r),i=((e=r.outStatistics)==null?void 0:e[0])!=null,a=tt("featurelayer-pbf-statistics"),c=!i||a;let u;if(this.format==="pbf"&&c)try{u=await xt(this.url,n,o)}catch(l){if(l.name!=="query:parsing-pbf")throw l;this.format="json"}return this.format!=="json"&&c||(u=await nt(this.url,n,o)),this._normalizeFields(u.fields),u}async featureSetFromJSON(r,t,e){if(!(this._queryIs3DObjectFormat(r)&&d(this.infoFor3D)&&t.features&&t.features.length))return D.fromJSON(t);const{meshFeatureSetFromJSON:o}=await et(import("./meshFeatureSet.097ef169.js").then(function(n){return n.a}),e);return o(r,this.infoFor3D,t)}executeForCount(r,t){const e=s(s({},this.requestOptions),t),o=this._normalizeQuery(r);return st(this.url,o,e)}executeForExtent(r,t){const e=s(s({},this.requestOptions),t),o=this._normalizeQuery(r);return gt(this.url,o,e)}executeForIds(r,t){const e=s(s({},this.requestOptions),t),o=this._normalizeQuery(r);return it(this.url,o,e)}executeRelationshipQuery(r,t){r=b.from(r);const e=s(s({},this.requestOptions),t);return(this.gdbVersion||this.dynamicDataSource)&&((r=r.clone()).gdbVersion=r.gdbVersion||this.gdbVersion,r.dynamicDataSource=r.dynamicDataSource||this.dynamicDataSource),It(this.url,r,e)}executeRelationshipQueryForCount(r,t){r=b.from(r);const e=s(s({},this.requestOptions),t);return(this.gdbVersion||this.dynamicDataSource)&&((r=r.clone()).gdbVersion=r.gdbVersion||this.gdbVersion,r.dynamicDataSource=r.dynamicDataSource||this.dynamicDataSource),Ct(this.url,r,e)}executeAttachmentQuery(r,t){const e=s(s({},this.requestOptions),t);return mt(this.url,r,e)}executeTopFeaturesQuery(r,t){const e=s(s({},this.requestOptions),t);return Tt(this.parsedUrl,r,this.sourceSpatialReference,e)}executeForTopIds(r,t){const e=s(s({},this.requestOptions),t);return Nt(this.parsedUrl,r,e)}executeForTopExtents(r,t){const e=s(s({},this.requestOptions),t);return Bt(this.parsedUrl,r,e)}executeForTopCount(r,t){const e=s(s({},this.requestOptions),t);return Jt(this.parsedUrl,r,e)}_normalizeQuery(r){let t=R.from(r);if(t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===r?t.clone():t,t.gdbVersion=r.gdbVersion||this.gdbVersion,t.dynamicDataSource=r.dynamicDataSource?G.from(r.dynamicDataSource):this.dynamicDataSource),d(this.infoFor3D)&&this._queryIs3DObjectFormat(r)){t=t===r?t.clone():t,t.formatOf3DObjects=null;for(const e of this.infoFor3D.queryFormats){if(e.id==="3D_glb"){t.formatOf3DObjects=e.id;break}e.id!=="3D_gltf"||t.formatOf3DObjects||(t.formatOf3DObjects=e.id)}if(!t.formatOf3DObjects)throw new rt("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(j(t.outFields)||!t.outFields.includes("*")){t=t===r?t.clone():t,j(t.outFields)&&(t.outFields=[]);const{originX:e,originY:o,originZ:n,translationX:i,translationY:a,translationZ:c,scaleX:u,scaleY:l,scaleZ:h,rotationX:N,rotationY:B,rotationZ:J,rotationDeg:k}=this.infoFor3D.transformFieldRoles;t.outFields.push(e,o,n,i,a,c,u,l,h,N,B,J,k)}}return t}_normalizeFields(r){if(d(this.fieldsIndex)&&d(r))for(const t of r){const e=this.fieldsIndex.get(t.name);e&&Object.assign(t,e.toJSON())}}_queryIs3DObjectFormat(r){return d(this.infoFor3D)&&r.returnGeometry&&r.multipatchOption!=="xyFootprint"&&!r.outStatistics}};m([g({type:G})],y.prototype,"dynamicDataSource",void 0),m([g()],y.prototype,"fieldsIndex",void 0),m([g()],y.prototype,"format",void 0),m([g()],y.prototype,"gdbVersion",void 0),m([g()],y.prototype,"infoFor3D",void 0),m([g()],y.prototype,"sourceSpatialReference",void 0),y=m([W("esri.tasks.QueryTask")],y);const Qt=y;export{Qt as Q,yt as a};
