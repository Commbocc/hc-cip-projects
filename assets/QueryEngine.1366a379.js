var Pt=Object.defineProperty,Ct=Object.defineProperties;var Ot=Object.getOwnPropertyDescriptors;var Qe=Object.getOwnPropertySymbols;var kt=Object.prototype.hasOwnProperty,Qt=Object.prototype.propertyIsEnumerable;var Ne=(r,e,t)=>e in r?Pt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ae=(r,e)=>{for(var t in e||(e={}))kt.call(e,t)&&Ne(r,t,e[t]);if(Qe)for(var t of Qe(e))Qt.call(e,t)&&Ne(r,t,e[t]);return r},Ve=(r,e)=>Ct(r,Ot(e));import{ct as Nt,cR as Vt,bV as X,as as M,cS as lt,cs as ve,E as F,D as R,U as v,Z as Lt,cT as zt,P as Re,cU as Dt,bW as Gt,cu as Le,cV as ze,cm as ct,cW as Ut,cX as Mt,L as he,cY as te,cZ as qt,c_ as jt,M as Bt,_ as b,$ as G,a0 as de,ar as fe,aX as ht,bU as le,c$ as Zt,R as Ht,d0 as ge,bT as ye,aN as Yt,bq as Wt,d1 as A,aF as Xt,d2 as Jt,d3 as Kt,d4 as es,d5 as dt,d6 as ts,cv as ss,d7 as De,aM as Ge,C as B,d8 as is,d9 as rs,da as as,bo as Ie,db as ns,dc as Ue,dd as os,bY as us}from"./vendor.b8b0b9ef.js";import{v as Ee}from"./normalizeUtils.7353462f.js";import{e as Me}from"./ItemCache.866d790e.js";import{WhereClause as ls}from"./WhereClause.cf4da79a.js";import{Y as ft,u as cs}from"./projection.4e77876b.js";import{t as mt}from"./json.2d0d6862.js";import{t as hs}from"./QueryEngineCapabilities.83e56447.js";import{i as we,G as Fe,f as ds,y as fs,U as ms,C as ps,_ as _s,e as gs,D as qe}from"./featureConversionUtils.e458978f.js";import{T as ys,s as Is,m as je,c as Be,V as xs,g as Ts,h as Ss,y as Rs,D as Es,z as ws,f as Fs,d as bs}from"./utils.4264471a.js";import{t as se}from"./OptimizedGeometry.11fe4dff.js";const xe=[0,0];function pt(r,e){if(!e)return null;if("x"in e){const t={x:0,y:0};return[t.x,t.y]=r(e.x,e.y,xe),e.z!=null&&(t.z=e.z),e.m!=null&&(t.m=e.m),t}if("xmin"in e){const t={xmin:0,ymin:0,xmax:0,ymax:0};return[t.xmin,t.ymin]=r(e.xmin,e.ymin,xe),[t.xmax,t.ymax]=r(e.xmax,e.ymax,xe),e.hasZ&&(t.zmin=e.zmin,t.zmax=e.zmax,t.hasZ=!0),e.hasM&&(t.mmin=e.mmin,t.mmax=e.mmax,t.hasM=!0),t}return"rings"in e?{rings:Ze(e.rings,r),hasM:e.hasM,hasZ:e.hasZ}:"paths"in e?{paths:Ze(e.paths,r),hasM:e.hasM,hasZ:e.hasZ}:"points"in e?{points:_t(e.points,r),hasM:e.hasM,hasZ:e.hasZ}:void 0}function Ze(r,e){const t=[];for(const i of r)t.push(_t(i,e));return t}function _t(r,e){const t=[];for(const i of r){const s=e(i[0],i[1],[0,0]);t.push(s),i.length>2&&s.push(i[2]),i.length>3&&s.push(i[3])}return t}async function Y(r,e){if(!e)return;const t=Array.isArray(r)?r.map(i=>F(i.geometry)&&i.geometry.spatialReference):[r];await cs(t.map(i=>({source:i,dest:e})))}const gt=pt.bind(null,Nt),yt=pt.bind(null,Vt);function q(r,e,t){return r&&(t||(t=e,e=r.spatialReference),X(e)&&X(t)&&!M(e,t)?lt(e,t)?ve(t)?gt(r):yt(r):ft(mt,[r],e,t,null)[0]:r)}class As{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(e,t,i){if(!e||!e.length||!t||!i||M(t,i))return e;const s={geometries:e,inSpatialReference:t,outSpatialReference:i,resolve:null};return this._jobs.push(s),new Promise(a=>{s.resolve=a,this._timer===null&&(this._timer=setTimeout(this._process,10))})}_process(){this._timer=null;const e=this._jobs.shift();if(!e)return;const{geometries:t,inSpatialReference:i,outSpatialReference:s,resolve:a}=e;lt(i,s)?ve(s)?a(t.map(gt)):a(t.map(yt)):a(ft(mt,t,i,s,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}}const vs=new As;function $s(r,e,t){return vs.push(r,e,t)}class Ps{constructor(e,t){this._cache=new Me(e),this._invalidCache=new Me(t)}get(e,t){const i=`${t.uid}:${e}`,s=this._cache.get(i);if(s)return s;if(this._invalidCache.get(i)!==void 0)return null;try{const a=ls.create(e,t);return this._cache.put(i,a),a}catch{return this._invalidCache.put(i,null),null}}}const $e=new Ps(50,500),V="feature-store:unsupported-query",It=" as ",Cs=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function Os(r,e){if(!e)return!0;const t=$e.get(e,r);if(!t)throw new R(V,"invalid SQL expression",{where:e});if(!t.isStandardized)throw new R(V,"where clause is not standard",{where:e});return N(r,t.fieldNames,"where clause contains missing fields"),!0}function ks(r,e,t){if(!e)return!0;const i=$e.get(e,r);if(!i)throw new R(V,"invalid SQL expression",{having:e});if(!i.isAggregate)throw new R(V,"having does not contain a valid aggregate function",{having:e});const s=i.fieldNames;if(N(r,s,"having contains missing fields"),!i.getExpressions().every(a=>{const{aggregateType:n,field:o}=a,u=r.has(o)&&r.get(o).name;return t.some(l=>{const{onStatisticField:c,statisticType:h}=l;return(r.has(c)&&r.get(c).name)===u&&h.toLowerCase().trim()===n})}))throw new R(V,"expressions in having should also exist in outStatistics",{having:e});return!0}function H(r,e){return r?$e.get(r,e):null}function N(r,e,t,i=!0){const s=[];for(const a of e)if(a!=="*"&&!r.has(a))if(i){const n=xt(a);try{const o=H(n,r);if(!o)throw new R(V,"invalid SQL expression",{where:n});if(!o.isStandardized)throw new R(V,"expression is not standard",{clause:o});N(r,o.fieldNames,"expression contains missing fields")}catch(o){const u=o&&o.details;if(u&&(u.clause||u.where))throw o;u&&u.missingFields?s.push(...u.missingFields):s.push(a)}}else s.push(a);if(s.length)throw new R(V,t,{missingFields:s})}function xt(r){return r.split(It)[0]}function Qs(r){return r.split(It)[1]}function Ns(r,e){const t=e.get(r);return!!t&&!Cs.has(t.type)}const Pe=(r,e,t)=>[e,t],J=(r,e,t)=>[e,t,r[2]],Ce=(r,e,t)=>[e,t,r[2],r[3]];function He(r){return r?{originPosition:r.originPosition==="upper-left"?"upperLeft":r.originPosition==="lower-left"?"lowerLeft":r.originPosition,scale:r.tolerance?[r.tolerance,r.tolerance]:[1,1],translate:F(r.extent)?[r.extent.xmin,r.extent.ymax]:[0,0]}:null}function Tt({scale:r,translate:e},t){return t*r[0]+e[0]}function St({scale:r,translate:e},t){return e[1]-t*r[1]}function Rt(r,e,t){const i=new Array(t.length);if(!t.length)return i;const[s,a]=r.scale;let n=Tt(r,t[0][0]),o=St(r,t[0][1]);i[0]=e(t[0],n,o);for(let u=1;u<t.length;u++){const l=t[u];n+=l[0]*s,o-=l[1]*a,i[u]=e(l,n,o)}return i}function Et(r,e,t){const i=new Array(t.length);for(let s=0;s<t.length;s++)i[s]=Rt(r,e,t[s]);return i}function Vs(r,e,t,i){return Rt(r,t?i?Ce:J:i?J:Pe,e)}function Ls(r,e,t,i){return Et(r,t?i?Ce:J:i?J:Pe,e)}function zs(r,e,t,i){return Et(r,t?i?Ce:J:i?J:Pe,e)}function bi(r,e,t,i,s){return F(t)&&(e.points=Vs(r,t.points,i,s)),e}function Ai(r,e,t,i,s){return v(t)||(e.x=Tt(r,t.x),e.y=St(r,t.y),e!==t&&(i&&(e.z=t.z),s&&(e.m=t.m))),e}function vi(r,e,t,i,s){return F(t)&&(e.rings=zs(r,t.rings,i,s)),e}function $i(r,e,t,i,s){return F(t)&&(e.paths=Ls(r,t.paths,i,s)),e}class ne{constructor(e,t,i){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues,this.fieldsIndex=i,this.featureAdapter=t;const s=e.outFields;if(s&&s.indexOf("*")===-1){this.outFields=s;let a=0;for(const n of s){const o=xt(n),u=this.fieldsIndex.get(o),l=u?null:H(o,i),c=u?u.name:Qs(n)||"FIELD_EXP_"+a++;this._fieldDataCache.set(n,{alias:c,clause:l})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(t=>this.getAttributes(t)),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,i){const s=i?i.name:t;let a=null;return this._fieldDataCache.has(s)?a=this._fieldDataCache.get(s).clause:i||(a=H(t,this.fieldsIndex),this._fieldDataCache.set(s,{alias:s,clause:a})),i?this.featureAdapter.getAttribute(e,s):a.calculateValue(e,this.featureAdapter)}getNormalizedValue(e,t){const i=t.normalizationType,s=t.normalizationTotal;let a=this.getFieldValue(e,t.field,t.fieldInfo);if(i&&Number.isFinite(a)){const n=this.getFieldValue(e,t.normalizationField,t.normalizationFieldInfo);a=ys(a,i,n,s)}return a}getExpressionValue(e,t,i){const s={attributes:this.featureAdapter.getAttributes(e)},a=i.createExecContext(s,t.viewInfo);return i.executeFunction(t.compiledFunc,a)}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:H(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testFeature(e,this.featureAdapter)}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:H(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testSet(e,this.featureAdapter)}_processAttributesForOutFields(e){const t=this.outFields;if(!t||!t.length)return this.featureAdapter.getAttributes(e);const i={};for(const s of t){const{alias:a,clause:n}=this._fieldDataCache.get(s);i[a]=n?n.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,a)}return i}_processAttributesForDistinctValues(e){if(v(e)||!this.returnDistinctValues)return e;const t=this.outFields,i=[];if(t)for(const n of t){const{alias:o}=this._fieldDataCache.get(n);i.push(e[o])}else for(const n in e)i.push(e[n]);const s=`${(t||["*"]).join(",")}=${i.join(",")}`;let a=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++a),a>1?null:e}}function Ds(r,e){if(!r)return null;const t=e.featureAdapter,{startTimeField:i,endTimeField:s}=r;let a=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;if(i&&s)e.forEach(o=>{const u=t.getAttribute(o,i),l=t.getAttribute(o,s);u==null||isNaN(u)||(a=Math.min(a,u)),l==null||isNaN(l)||(n=Math.max(n,l))});else{const o=i||s;e.forEach(u=>{const l=t.getAttribute(u,o);l==null||isNaN(l)||(a=Math.min(a,l),n=Math.max(n,l))})}return{start:a,end:n}}function Gs(r,e,t){if(!e||!r)return null;const{startTimeField:i,endTimeField:s}=r;if(!i&&!s)return null;const{start:a,end:n}=e;return a===null&&n===null?null:a===void 0&&n===void 0?qs():i&&s?Us(t,i,s,a,n):Ms(t,i||s,a,n)}function Us(r,e,t,i,s){return i!=null&&s!=null?a=>{const n=r.getAttribute(a,e),o=r.getAttribute(a,t);return(n==null||n<=s)&&(o==null||o>=i)}:i!=null?a=>{const n=r.getAttribute(a,t);return n==null||n>=i}:s!=null?a=>{const n=r.getAttribute(a,e);return n==null||n<=s}:void 0}function Ms(r,e,t,i){return t!=null&&i!=null&&t===i?s=>r.getAttribute(s,e)===t:t!=null&&i!=null?s=>{const a=r.getAttribute(s,e);return a>=t&&a<=i}:t!=null?s=>r.getAttribute(s,e)>=t:i!=null?s=>r.getAttribute(s,e)<=i:void 0}function qs(){return()=>!1}const js=new Lt({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),Q=Object.freeze({}),Ye=new se,Bs=new se,be=new se,Te={esriGeometryPoint:Fe,esriGeometryPolyline:ms,esriGeometryPolygon:ps,esriGeometryMultipoint:_s};function We(r,e,t,i=r.hasZ,s=r.hasM){if(v(e))return null;const a=r.hasZ&&i,n=r.hasM&&s;if(t){const o=we(be,e,r.hasZ,r.hasM,"esriGeometryPoint",t,i,s);return Fe(o,a,n)}return Fe(e,a,n)}function U(r,e,t,i,s,a,n=e,o=t){const u=e&&n,l=t&&o,c=F(i)?"coords"in i?i:i.geometry:null;if(v(c))return null;if(s){let h=ds(Bs,c,e,t,r,s,n,o);return a&&(h=we(be,h,u,l,r,a)),Te[r](h,u,l)}if(a){const h=we(be,c,e,t,r,a,n,o);return Te[r](h,u,l)}return fs(Ye,c,e,t,n,o),Te[r](Ye,u,l)}async function Z(r,e,t){const{outFields:i,orderByFields:s,groupByFieldsForStatistics:a,outStatistics:n}=r;if(i)for(let o=0;o<i.length;o++)i[o]=i[o].trim();if(s)for(let o=0;o<s.length;o++)s[o]=s[o].trim();if(a)for(let o=0;o<a.length;o++)a[o]=a[o].trim();if(n)for(let o=0;o<n.length;o++)n[o].onStatisticField&&(n[o].onStatisticField=n[o].onStatisticField.trim());return r.geometry&&!r.outSR&&(r.outSR=r.geometry.spatialReference),Zs(r,e,t)}async function Zs(r,e,t){if(!r)return null;let{where:i}=r;if(r.where=i=i&&i.trim(),(!i||/^1 *= *1$/.test(i)||e&&e===i)&&(r.where=null),!r.geometry)return r;let s=await Hs(r);if(r.distance=0,r.units=null,r.spatialRel==="esriSpatialRelEnvelopeIntersects"){const{spatialReference:u}=r.geometry;s=zt(s),s.spatialReference=u}r.geometry=s,await Y(s.spatialReference,t);const a=(await Ee(Re(s)))[0];if(v(a))throw Q;const n=a.toJSON(),o=await q(n,n.spatialReference,t);if(!o)throw Q;return o.spatialReference=t,r.geometry=o,r}async function Hs(r){const{geometry:e,distance:t,units:i}=r;if(t==null||"vertexAttributes"in e)return e;const s=e.spatialReference,a=i?js.fromJSON(i):Dt(s),n=s&&(Gt(s)||ve(s))?e:await Y(s,Le).then(()=>q(e,Le));return(await Ys())(n.spatialReference,n,t,a)}async function Ys(){return(await import("./geometryEngineJSON.1787cb60.js")).geodesicBuffer}function W(r){return r&&wt in r?JSON.parse(JSON.stringify(r,Ws)):r}const wt="_geVersion",Ws=(r,e)=>r!==wt?e:void 0;class E{constructor(e,t,i){this.items=e,this.queryGeometry=t,this.definitionExpression=i.definitionExpression,this.geometryType=i.geometryType,this.hasM=i.hasM,this.hasZ=i.hasZ,this.objectIdField=i.objectIdField,this.spatialReference=i.spatialReference,this.fieldsIndex=i.fieldsIndex,this.timeInfo=i.timeInfo,this.featureAdapter=i.featureAdapter,this.aggregateAdapter=i.aggregateAdapter}get size(){return this.items.length}createQueryResponseForCount(e){const t=new ne(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);const{groupByFieldsForStatistics:i,having:s}=e;if(!(i!=null&&i.length))return 1;const a=new Map,n=new Map,o=new Set,u=e.outStatistics;for(const l of u){const{statisticType:c}=l,h=c!=="exceedslimit"?l.onStatisticField:void 0;if(!n.has(h)){const _=[];for(const d of i){const x=this._getAttributeValues(t,d,a);_.push(x)}n.set(h,this._calculateUniqueValues(_,t.returnDistinctValues))}const f=n.get(h);for(const _ in f){const{data:d,items:x}=f[_],m=d.join(",");s&&!t.validateItems(x,s)||o.add(m)}}return o.size}createQueryResponse(e){let t;return e.outStatistics?t=e.outStatistics.some(i=>i.statisticType==="exceedslimit")?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):t=this._createFeatureQueryResponse(e),e.returnQueryGeometry&&(X(e.outSR)&&!M(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=W(ae({spatialReference:e.outSR},q(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR))):t.queryGeometry=W(ae({spatialReference:e.outSR},this.queryGeometry))),t}createSnappingResponse(e,t){const i=this.featureAdapter,s=Js(this.hasZ,this.hasM),{x:a,y:n}=e.point,o=typeof e.distance=="number"?e.distance:e.distance.x,u=typeof e.distance=="number"?e.distance:e.distance.y,l={candidates:[]},c=this.geometryType==="esriGeometryPolygon",h=this.getPointCreator(e.point,this.spatialReference,t);for(const f of this.items){const _=i.getGeometry(f);if(v(_))continue;const{coords:d,lengths:x}=_;if(1&e.types){let m=0;for(let g=0;g<x.length;g++){const S=x[g];for(let T=0;T<S;T++,m+=s){const w=d[m],I=d[m+1];if(T!==S-1){const y=d[m+s],$=d[m+s+1],{x:ie,y:O}=Xs(a,n,w,I,y,$),L=(a-ie)/o,j=(n-O)/u,z=L*L+j*j;z<=1&&l.candidates.push({type:"edge",objectId:i.getObjectId(f),distance:Math.sqrt(z),target:h(ie,O),start:h(w,I),end:h(y,$)})}}}}if(2&e.types){const m=c?d.length-s:d.length;for(let g=0;g<m;g+=s){const S=d[g],T=d[g+1],w=(a-S)/o,I=(n-T)/u,y=w*w+I*I;y<=1&&l.candidates.push({type:"vertex",objectId:i.getObjectId(f),distance:Math.sqrt(y),target:h(S,T)})}}}return l.candidates.sort((f,_)=>f.distance-_.distance),l}getPointCreator(e,t,i){const s=F(i)&&!M(t,i)?a=>q(a,t,i):a=>a;return e.z!=null&&e.m!=null?(a,n)=>s({x:a,y:n,z:e.z,m:e.m}):e.z!=null?(a,n)=>s({x:a,y:n,z:e.z}):e.m!=null?(a,n)=>s({x:a,y:n,m:e.m}):(a,n)=>s({x:a,y:n})}executeAttributesQuery(e){const t=H(e.where,this.fieldsIndex);if(!t)return Promise.resolve(this);if(t.isStandardized){let i=0;const s=[];for(const n of this.items)t.testFeature(n,this.featureAdapter)&&(s[i++]=n);const a=new E(s,this.queryGeometry,this);return a.definitionExpression=e.where,Promise.resolve(a)}return Promise.reject(new TypeError("Where clause is not standardized"))}executeAggregateIdsQuery(e){if(!e.aggregateIds||!e.aggregateIds.length||v(this.aggregateAdapter))return Promise.resolve(this);const t=new Set;for(const s of e.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(s).forEach(a=>t.add(a));const i=this.featureAdapter.getObjectId;return Promise.resolve(new E(this.items.filter(s=>t.has(i(s))),this.queryGeometry,this))}executeObjectIdsQuery(e){if(!e.objectIds||!e.objectIds.length)return Promise.resolve(this);const t=new Set(e.objectIds),i=this.featureAdapter.getObjectId;return Promise.resolve(new E(this.items.filter(s=>t.has(i(s))),this.queryGeometry,this))}executeTimeQuery(e){const t=Gs(this.timeInfo,e.timeExtent,this.featureAdapter);if(!F(t))return Promise.resolve(this);const i=this.items.filter(t);return Promise.resolve(new E(i,this.queryGeometry,this))}filterLatest(){const{trackIdField:e,startTimeField:t,endTimeField:i}=this.timeInfo,s=i||t,a=new Map,n=this.featureAdapter.getAttribute;for(const u of this.items){const l=n(u,e),c=n(u,s),h=a.get(l);(!h||c>n(h,s))&&a.set(l,u)}const o=Array.from(a.values());return Promise.resolve(new E(o,this.queryGeometry,this))}async project(e){if(!e||M(this.spatialReference,e))return this;const t=this.featureAdapter,i=(await $s(this.items.map(s=>U(this.geometryType,this.hasZ,this.hasM,t.getGeometry(s))),this.spatialReference,e)).map((s,a)=>t.cloneWithGeometry(this.items[a],gs(s,this.hasZ,this.hasM)));return new E(i,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:e,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})}async createSummaryStatisticsResponse(e,t){const{field:i,valueExpression:s,normalizationField:a,normalizationType:n,normalizationTotal:o,minValue:u,maxValue:l,scale:c}=t,h=this.fieldsIndex.isDateField(i),f=await this._getDataValues(e,{field:i,valueExpression:s,normalizationField:a,normalizationType:n,normalizationTotal:o,scale:c}),_=Is({normalizationType:n,normalizationField:a,minValue:u,maxValue:l}),d=this.fieldsIndex.get(i),x={value:.5,fieldType:d==null?void 0:d.type},m=ze(d)?je({values:f,supportsNullCount:_,percentileParams:x}):Be({values:f,minValue:u,maxValue:l,useSampleStdDev:!n,supportsNullCount:_,percentileParams:x});return xs(m,h)}async createUniqueValuesResponse(e,t){const{field:i,valueExpression:s,domain:a,returnAllCodedValues:n,scale:o}=t,u=await this._getDataValues(e,{field:i,valueExpression:s,scale:o}),l=Ts(u);return Ss(l,a,n)}async createClassBreaksResponse(e,t){const{field:i,valueExpression:s,normalizationField:a,normalizationType:n,normalizationTotal:o,classificationMethod:u,standardDeviationInterval:l,minValue:c,maxValue:h,numClasses:f,scale:_}=t,d=await this._getDataValues(e,{field:i,valueExpression:s,normalizationField:a,normalizationType:n,normalizationTotal:o,scale:_}),x=Rs(d,{field:i,normalizationField:a,normalizationType:n,normalizationTotal:o,classificationMethod:u,standardDeviationInterval:l,minValue:c,maxValue:h,numClasses:f});return Es(x,u)}async createHistogramResponse(e,t){const{field:i,valueExpression:s,normalizationField:a,normalizationType:n,normalizationTotal:o,classificationMethod:u,standardDeviationInterval:l,minValue:c,maxValue:h,numBins:f,scale:_}=t,d=await this._getDataValues(e,{field:i,valueExpression:s,normalizationField:a,normalizationType:n,normalizationTotal:o,scale:_});return ws(d,{field:i,normalizationField:a,normalizationType:n,normalizationTotal:o,classificationMethod:u,standardDeviationInterval:l,minValue:c,maxValue:h,numBins:f})}_sortFeatures(e,t,i){if(e.length>1&&t&&t.length)for(const s of t.reverse()){const a=s.split(" "),n=a[0],o=this.fieldsIndex.get(n),u=a[1]&&a[1].toLowerCase()==="desc",l=Fs(o==null?void 0:o.type,u);e.sort((c,h)=>{const f=i(c,n,o),_=i(h,n,o);return l(f,_)})}}_createFeatureQueryResponse(e){const t=this.items,{geometryType:i,hasM:s,hasZ:a,objectIdField:n,spatialReference:o}=this,{outFields:u,outSR:l,quantizationParameters:c,resultRecordCount:h,resultOffset:f,returnZ:_,returnM:d}=e,x=h!=null&&t.length>(f||0)+h,m=u&&(u.includes("*")?[...this.fieldsIndex.fields]:u.map(g=>this.fieldsIndex.get(g)));return{exceededTransferLimit:x,features:this._createFeatures(e,t),fields:m,geometryType:i,hasM:s&&d,hasZ:a&&_,objectIdFieldName:n,spatialReference:W(l||o),transform:c&&He(c)||null}}_createFeatures(e,t){const i=new ne(e,this.featureAdapter,this.fieldsIndex),{hasM:s,hasZ:a}=this,{orderByFields:n,quantizationParameters:o,returnGeometry:u,returnCentroid:l,maxAllowableOffset:c,resultOffset:h,resultRecordCount:f,returnZ:_=!1,returnM:d=!1}=e,x=a&&_,m=s&&d;let g=[],S=0;const T=[...t];if(this._sortFeatures(T,n,(I,y,$)=>i.getFieldValue(I,y,$)),u||l){const I=He(o);if(u&&!l)for(const y of T)g[S++]={attributes:i.getAttributes(y),geometry:U(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(y),c,I,x,m)};else if(!u&&l)for(const y of T)g[S++]={attributes:i.getAttributes(y),centroid:We(this,this.featureAdapter.getCentroid(y,this),I)};else for(const y of T)g[S++]={attributes:i.getAttributes(y),centroid:We(this,this.featureAdapter.getCentroid(y,this),I),geometry:U(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(y),c,I,x,m)}}else for(const I of T){const y=i.getAttributes(I);y&&(g[S++]={attributes:y})}const w=h||0;if(f!=null){const I=w+f;g=g.slice(w,Math.min(g.length,I))}return g}_createExceedsLimitQueryResponse(e){let t=!1,i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY;for(const n of e.outStatistics)if(n.statisticType==="exceedslimit"){i=n.maxPointCount!=null?n.maxPointCount:Number.POSITIVE_INFINITY,s=n.maxRecordCount!=null?n.maxRecordCount:Number.POSITIVE_INFINITY,a=n.maxVertexCount!=null?n.maxVertexCount:Number.POSITIVE_INFINITY;break}if(this.geometryType==="esriGeometryPoint")t=this.items.length>i;else if(this.items.length>s)t=!0;else{const n=this.hasZ?this.hasM?4:3:this.hasM?3:2,o=this.featureAdapter;t=this.items.reduce((u,l)=>{const c=o.getGeometry(l);return u+(F(c)&&c.coords.length||0)},0)/n>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}}_createStatisticsQueryResponse(e){const t={attributes:{}},i=[],s=new Map,a=new Map,n=new Map,o=new Map,u=new ne(e,this.featureAdapter,this.fieldsIndex),l=e.outStatistics,{groupByFieldsForStatistics:c,having:h,orderByFields:f}=e,_=c&&c.length,d=!!_,x=d&&c[0],m=d&&!this.fieldsIndex.get(x);for(const S of l){const{outStatisticFieldName:T,statisticType:w}=S,I=S,y=w!=="exceedslimit"?S.onStatisticField:void 0,$=w==="percentile_disc"||w==="percentile_cont",ie=d&&_===1&&(y===x||m)&&w==="count";if(d){if(!n.has(y)){const L=[];for(const j of c){const z=this._getAttributeValues(u,j,s);L.push(z)}n.set(y,this._calculateUniqueValues(L,u.returnDistinctValues))}const O=n.get(y);for(const L in O){const{count:j,data:z,items:At,itemPositions:vt}=O[L],ke=z.join(",");if(!h||u.validateItems(At,h)){const pe=o.get(ke)||{attributes:{}};let _e=null;if(ie)_e=j;else{const re=this._getAttributeValues(u,y,s),K=vt.map($t=>re[$t]);_e=$&&"statisticParameters"in I?this._getPercentileValue(I,K):this._getStatisticValue(I,K,null,u.returnDistinctValues)}pe.attributes[T]=_e,c.forEach((re,K)=>pe.attributes[this.fieldsIndex.get(re)?re:`EXPR_${K+1}`]=z[K]),o.set(ke,pe)}}}else{const O=this._getAttributeValues(u,y,s);t.attributes[T]=$&&"statisticParameters"in I?this._getPercentileValue(I,O):this._getStatisticValue(I,O,a,u.returnDistinctValues)}i.push({name:T,alias:T,type:"esriFieldTypeDouble"})}const g=d?Array.from(o.values()):[t];return this._sortFeatures(g,f,(S,T)=>S.attributes[T]),{fields:i,features:g}}_getStatisticValue(e,t,i,s){const{onStatisticField:a,statisticType:n}=e;let o=null;return o=i!=null&&i.has(a)?i.get(a):ze(this.fieldsIndex.get(a))?je({values:t,returnDistinct:s}):Be({values:t,minValue:null,maxValue:null,useSampleStdDev:!0}),i&&i.set(a,o),o[n==="var"?"variance":n]}_getPercentileValue(e,t){const{onStatisticField:i,statisticParameters:s,statisticType:a}=e,{value:n,orderBy:o}=s,u=this.fieldsIndex.get(i),l={value:n,orderBy:o,fieldType:u==null?void 0:u.type,isDiscrete:a==="percentile_disc"};return bs(t,l)}_getAttributeValues(e,t,i){if(i.has(t))return i.get(t);const s=this.fieldsIndex.get(t),a=this.items.map(n=>e.getFieldValue(n,t,s));return i.set(t,a),a}_getAttributeNormalizedValues(e,t){return this.items.map(i=>e.getNormalizedValue(i,{field:t.field,fieldInfo:this.fieldsIndex.get(t.field),normalizationField:t.normalizationField,normalizationFieldInfo:this.fieldsIndex.get(t.normalizationField),normalizationType:t.normalizationType,normalizationTotal:t.normalizationTotal}))}async _getAttributeExpressionValues(e,t,i){const{arcadeUtils:s}=await ct(),a=s.createFunction(t),n=i&&s.getViewInfo(i);return this.items.map(o=>e.getExpressionValue(o,{compiledFunc:a,viewInfo:n},s))}_calculateUniqueValues(e,t){const i={},s=this.items,a=s.length;for(let n=0;n<a;n++){const o=s[n],u=[];for(const c of e)u.push(c[n]);const l=u.join(",");t?i[l]==null&&(i[l]={count:1,data:u,items:[o],itemPositions:[n]}):i[l]==null?i[l]={count:1,data:u,items:[o],itemPositions:[n]}:(i[l].count++,i[l].items.push(o),i[l].itemPositions.push(n))}return i}async _getDataValues(e,t){const i=new ne(e,this.featureAdapter,this.fieldsIndex),{valueExpression:s,field:a,normalizationField:n,normalizationType:o,normalizationTotal:u,scale:l}=t,c=s?{viewingMode:"map",scale:l,spatialReference:e.outSR||this.spatialReference}:null;return s?this._getAttributeExpressionValues(i,s,c):this._getAttributeNormalizedValues(i,{field:a,normalizationField:n,normalizationType:o,normalizationTotal:u})}}function Xs(r,e,t,i,s,a){const n=s-t,o=a-i,u=n*n+o*o,l=(r-t)*n+(e-i)*o,c=Math.min(1,Math.max(0,l/u));return{x:t+n*c,y:i+o*c}}function Js(r,e){return r?e?4:3:e?3:2}function Ks(r){return r==="mesh"?Ut:Mt(r)}function Ft(r,e){return r?e?4:3:e?3:2}function ei(r,e,t,i){return bt(r,e,t,i.coords[0],i.coords[1])}function ti(r,e,t,i,s,a){const n=Ft(s,a),{coords:o,lengths:u}=i;if(!u)return!1;for(let l=0,c=0;l<u.length;l++,c+=n)if(!bt(r,e,t,o[c],o[c+1]))return!1;return!0}function bt(r,e,t,i,s){if(!r)return!1;const a=Ft(e,t),{coords:n,lengths:o}=r;let u=!1,l=0;for(const c of o)u=si(u,n,a,l,c,i,s),l+=c*a;return u}function si(r,e,t,i,s,a,n){let o=r,u=i;for(let l=i,c=i+s*t;l<c;l+=t){u=l+t,u===c&&(u=i);const h=e[l],f=e[l+1],_=e[u],d=e[u+1];(f<n&&d>=n||d<n&&f>=n)&&h+(n-f)/(d-f)*(_-h)<a&&(o=!o)}return o}const Se="feature-store:unsupported-query",ii={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},Oe={spatialRelationship:{esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},queryGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},layerGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1}};function ri(r){return Oe.spatialRelationship[r]===!0}function ai(r){return Oe.queryGeometry[Bt(r)]===!0}function ni(r){return Oe.layerGeometry[r]===!0}function oi(){return import("./geometryEngineJSON.1787cb60.js")}function Xe(r,e,t,i,s){if(he(e)&&t==="esriGeometryPoint"&&(r==="esriSpatialRelIntersects"||r==="esriSpatialRelContains")){const a=qe(new se,e,!1,!1);return Promise.resolve(n=>ei(a,!1,!1,n))}if(he(e)&&t==="esriGeometryMultipoint"){const a=qe(new se,e,!1,!1);if(r==="esriSpatialRelContains")return Promise.resolve(n=>ti(a,!1,!1,n,i,s))}if(te(e)&&t==="esriGeometryPoint"&&(r==="esriSpatialRelIntersects"||r==="esriSpatialRelContains"))return Promise.resolve(a=>qt(e,U(t,i,s,a)));if(te(e)&&t==="esriGeometryMultipoint"&&r==="esriSpatialRelContains")return Promise.resolve(a=>jt(e,U(t,i,s,a)));if(te(e)&&r==="esriSpatialRelIntersects"){const a=Ks(t);return Promise.resolve(n=>a(e,U(t,i,s,n)))}return oi().then(a=>{const n=a[ii[r]].bind(null,e.spatialReference,e);return o=>n(U(t,i,s,o))})}async function Je(r,e,t){const{spatialRel:i,geometry:s}=r;if(s){if(!ri(i))throw new R(Se,"Unsupported query spatial relationship",{query:r});if(X(s.spatialReference)&&X(t)){if(!ai(s))throw new R(Se,"Unsupported query geometry type",{query:r});if(!ni(e))throw new R(Se,"Unsupported layer geometry type",{query:r});if(r.outSR)return Y(r.geometry&&r.geometry.spatialReference,r.outSR)}}}function Ke(r){if(te(r))return!0;if(he(r)){for(const e of r.rings)if(e.length!==5||e[0][0]!==e[1][0]||e[0][0]!==e[4][0]||e[2][0]!==e[3][0]||e[0][1]!==e[3][1]||e[0][1]!==e[4][1]||e[1][1]!==e[2][1])return!1;return!0}return!1}let ce=class extends fe{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(r){for(;!r.done&&this._process(r);)r.madeProgress()}push(r,e,t){return this.running=!0,new Promise((i,s)=>this._tasks.push(new et(i,s,r,e,t)))}unshift(r,e,t){return this.running=!0,new Promise((i,s)=>this._tasks.unshift(new et(i,s,r,e,t)))}_process(r){if(this._tasks.length===0)return!1;const e=this._tasks.shift();try{const t=ht(e.signal);if(t&&!e.abortCallback)e.reject(le());else{const i=t?e.abortCallback(le()):e.callback(r);Zt(i)?i.then(e.resolve,e.reject):e.resolve(i)}}catch(t){e.reject(t)}return this.running=this._tasks.length>0,!0}cancelAll(){const r=le();for(const e of this._tasks)if(e.abortCallback){const t=e.abortCallback(r);e.resolve(t)}else e.reject(r);this._tasks.length=0,this.running=!1}};b([G()],ce.prototype,"running",void 0),ce=b([de("esri.layers.support.PromiseQueue")],ce);class et{constructor(e,t,i,s,a){this.resolve=e,this.reject=t,this.callback=i,this.signal=s,this.abortCallback=a}}let ee=class extends fe{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};b([G()],ee.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),b([G()],ee.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),ee=b([de("esri.views.support.DebugFlags")],ee);const ui=new ee,li=Ht.getLogger("esri.views.support.Scheduler");var p;(function(r){r.RESOURCE_CONTROLLER="schedule",r.SLIDE="slide",r.STREAM_DATA_LOADER="stream loader",r.ELEVATION_QUERY="elevation query",r.TERRAIN_SURFACE="terrain",r.SURFACE_GEOMETRY_UPDATES="surface geometry updates",r.GRAPHICS_CORE="Graphics3D",r.I3S_CONTROLLER="I3S",r.POINT_CLOUD_LAYER="point cloud",r.FEATURE_TILE_FETCHER="feature fetcher",r.OVERLAY="overlay",r.STAGE="stage",r.GRAPHICS_DECONFLICTOR="graphics deconflictor",r.FILTER_VISIBILITY="Graphics3D filter visibility",r.SCALE_VISIBILITY="Graphics3D scale visibility",r.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",r.POINT_OF_INTEREST_FREQUENT="POI frequent",r.POINT_OF_INTEREST_INFREQUENT="POI infrequent",r.LABELER="labeler",r.FEATURE_QUERY_ENGINE="feature query",r.FEATURE_TILE_TREE="feature tile tree",r.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",r.ELEVATION_ALIGNMENT="elevation alignment",r.TEXT_TEXTURE_ATLAS="text texture atlas",r.TEXTURE_UNLOAD="texture unload",r.LINE_OF_SIGHT_TOOL="line of sight tool",r.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",r.ELEVATION_PROFILE="elevation profile",r.SNAPPING="snapping",r.SHADOW_ACCUMULATOR="shadow accumulator",r.CLOUDS_GENERATOR="cloud generator",r[r.TEST_PRIO=1]="TEST_PRIO"})(p||(p={}));const C=0,tt=new Map([[p.RESOURCE_CONTROLLER,C],[p.SLIDE,C],[p.STREAM_DATA_LOADER,C],[p.ELEVATION_QUERY,C],[p.TERRAIN_SURFACE,1],[p.SURFACE_GEOMETRY_UPDATES,1],[p.GRAPHICS_CORE,2],[p.I3S_CONTROLLER,2],[p.POINT_CLOUD_LAYER,2],[p.FEATURE_TILE_FETCHER,2],[p.OVERLAY,4],[p.STAGE,4],[p.GRAPHICS_DECONFLICTOR,4],[p.FILTER_VISIBILITY,4],[p.SCALE_VISIBILITY,4],[p.FRUSTUM_VISIBILITY,4],[p.POINT_OF_INTEREST_FREQUENT,6],[p.POINT_OF_INTEREST_INFREQUENT,30],[p.LABELER,8],[p.FEATURE_QUERY_ENGINE,8],[p.FEATURE_TILE_TREE,16],[p.FEATURE_TILE_TREE_ACTIVE,C],[p.ELEVATION_ALIGNMENT,12],[p.TEXT_TEXTURE_ATLAS,12],[p.CLOUDS_GENERATOR,12],[p.TEXTURE_UNLOAD,12],[p.LINE_OF_SIGHT_TOOL,16],[p.LINE_OF_SIGHT_TOOL_INTERACTIVE,C],[p.SNAPPING,C],[p.SHADOW_ACCUMULATOR,30]]);function st(r){return tt.has(r)?tt.get(r):typeof r=="number"?r:1}const it=A(6.5),rt=A(1),ci=A(30),at=A(1e3/30),nt=A(100),ot=.9;var Ae,D;(function(r){let e=class extends fe{constructor(s){super(s),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new ge("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=1,this._tasks=new ye,this._runQueue=new ye,this._load=0,this._idleStateCallbacks=new ye,this._idleUpdatesStartFired=!1,this._maxReschedule=oe,this._forceTask=!1,this._debug=!1,this._debugHandle=Yt(ui,"SCHEDULER_LOG_SLOW_TASKS",o=>this._debug=o),this._budget=new i(s.nowFunc);for(const o of Object.keys(p))this.performanceInfo.tasks.set(p[o],new ge(p[o]));let a;const n=this;this._test={get state(){return Wt(a,n._state)},set state(o){a=o},FRAME_SAFETY_BUDGET:it,INTERACTING_BUDGET:at,IDLE_BUDGET:nt,get budget(){return n._budget.budget},usedBudget:0,setBudget:o=>n._budget=o,updateTask:o=>this._updateTask(o),getState:o=>this._getState(o),getRuntime:o=>this._getRuntime(o),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._debugHandle&&this._debugHandle.remove(),this._microTaskQueued=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=oe,this._schedule(),this.frame()))}))}registerTask(s,a){const n=st(s),o=new t(this,s,a,n);return this._tasks.push(o),this.performanceInfo.tasks.has(s)||this.performanceInfo.tasks.set(s,new ge(s)),o}registerIdleStateCallbacks(s,a){const n={idleBegin:s,idleEnd:a};this._idleStateCallbacks.push(n),this.state===2&&this._idleUpdatesStartFired&&n.idleBegin();const o=this;return{remove:()=>this._removeIdleStateCallbacks(n),set idleBegin(u){o._idleUpdatesStartFired&&(n.idleEnd(),o._state===2&&u()),n.idleBegin=u},set idleEnd(u){n.idleEnd=u}}}get now(){return this.nowFunc()}get load(){return this._load}set state(s){this._state!==s&&(this._state=s,this.state!==2&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(a=>a.idleEnd())))}get state(){return v(this._test.state)?this._state:this._test.state}updateBudget(s){this._test.usedBudget=0;let a=it,n=s.frameDuration,o=rt;switch(this.state){case 2:a=A(0),n=A(Math.max(nt,s.frameDuration)),o=ci;break;case 1:n=A(Math.max(at,s.frameDuration))}return n=A(n-s.elapsedFrameTime-a),this.state!==2&&n<rt&&!this._forceTask?(this._forceTask=!0,!1):(n=A(Math.max(n,o)),this._budget.reset(n,this.state),this._maxReschedule=oe,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(s=>s.idleBegin())),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(A(0),this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(s){this._idleUpdatesStartFired&&s.idleEnd(),this._idleStateCallbacks.removeUnordered(s)}removeTask(s){this._tasks.removeUnordered(s),this._runQueue.removeUnordered(s)}_updateTask(s){this._tasks.forAll(a=>{a.name===s&&a.setPriority(s)})}_getState(s){if(this._runQueue.some(n=>n.name===s))return D.SCHEDULED;let a=D.IDLE;return this._tasks.forAll(n=>{n.name===s&&n.needsUpdate&&(n.schedulePriority<=1?a=D.READY:a!==D.READY&&(a=D.WAITING))}),a}_getRuntime(s){let a=0;return this._tasks.forAll(n=>{n.name===s&&(a+=n.runtime)}),a}_resetRuntimes(){this._tasks.forAll(s=>s.runtime=0)}_getRunning(){const s=new Map;if(this._tasks.forAll(n=>{n.needsUpdate&&s.set(n.name,(s.get(n.name)||0)+1)}),s.size===0)return null;let a="";return s.forEach((n,o)=>{a+=n>1?` ${n}x ${o}`:` ${o}`}),a}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const s=this._tasks.reduce((a,n)=>n.needsUpdate?++a:a,0);this._load=this._load*ot+s*(1-ot)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace(s=>!!s.needsUpdate||(s.schedulePriority=s.basePriority,!1)),this._tasks.forAll(s=>{s.basePriority===C&&s.needsUpdate&&!this._runQueue.some(a=>a===s)&&this._runQueue.unshift(s)});this._runQueue.length===0;){let s=!1,a=0;if(this._tasks.forAll(n=>{n.needsUpdate&&n.schedulePriority!==0&&n.basePriority!==C&&(s=!0,a=Math.max(a,n.basePriority),n.schedulePriority===1?(n.schedulePriority=0,this._runQueue.push(n)):--n.schedulePriority)}),!s)return this.updating=!1,!1;this._maxReschedule===oe&&(this._maxReschedule=a),--this._maxReschedule}return this.updating=!0,!0}_run(){const s=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const a=this._budget.now(),n=this._runQueue.pop();this._budget.resetProgress();try{n.task.runTask(this._budget)}catch(u){li.error(`Exception in task "${n.name}"`,u)}n.schedulePriority=n.basePriority;const o=this._budget.now()-a;if(n.runtime+=o,this._frameTaskTimes.set(n.priority,this._frameTaskTimes.get(n.priority)+o),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",n.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(this._budget.now()-s)}while(this._schedule());this._recordFrameTaskTimes(this._budget.now()-s)}_startFrameTaskTimes(){for(const s of Object.keys(p))this._frameTaskTimes.set(p[s],0)}_recordFrameTaskTimes(s){this._frameTaskTimes.forEach((a,n)=>this.performanceInfo.tasks.get(n).record(a)),this.performanceInfo.total.record(s)}get test(){return this._test}};b([G()],e.prototype,"updating",void 0),b([G()],e.prototype,"nowFunc",void 0),e=b([de("esri.views.support.Scheduler")],e),r.Scheduler=e;let t=class extends fe{constructor(s,a,n,o){super({}),this._scheduler=s,this.name=a,this._basePriority=o,this.runtime=0,this._queue=new ce,this._handles=new Xt,this.schedulePriority=this._basePriority,this.task=F(n)?n:this._queue,this._handles.add(Jt(()=>this.task.running,()=>s.activate()))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(me),this._scheduler.removeTask(this),this.schedule=ut.schedule,this.reschedule=ut.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(s){this.name=s;const a=st(s);this._basePriority!==C&&this.schedulePriority===0||(this.schedulePriority=a),this._basePriority=a}get priority(){return this.name}set priority(s){this.setPriority(s)}get needsUpdate(){return this.updating||this.task.running}schedule(s,a,n){return this._queue.push(s,a,n)}reschedule(s,a,n){return this._queue.unshift(s,a,n)}processQueue(s){this._queue.runTask(s)}};b([G({constructOnly:!0})],t.prototype,"task",void 0),b([G({readOnly:!0})],t.prototype,"updating",null),t=b([de("esri.views.support.SchedulerTask")],t);class i{constructor(a){this.now=a,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}run(a){return!this.done&&(a()===!0&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(a){this._enabled=a}reset(a,n){this._begin=this.now(),this._budget=a,this._state=n,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}r.Budget=i})(Ae||(Ae={})),function(r){r.SCHEDULED="s",r.READY="r",r.WAITING="w",r.IDLE="i"}(D||(D={}));const me=(()=>{const r=new Ae.Budget(()=>performance.now());return r.enabled=!1,r})();class hi{remove(){}processQueue(){}schedule(e,t,i){try{if(ht(t)){const s=le();return i?Promise.resolve(i(s)):Promise.reject(s)}return Kt(e(me))}catch(s){return Promise.reject(s)}}reschedule(e,t,i){return this.schedule(e,t,i)}}const ut=new hi,oe=Number.MAX_SAFE_INTEGER;function di(r){return r.every(e=>e.statisticType!=="exceedslimit")}const k="feature-store:unsupported-query",ue=new Set,fi=new es(2e6);let mi=0;class Pi{constructor(e){this.capabilities={query:hs},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",()=>this.clearCache()),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new ts(mi+++"$$",fi)),this.fieldsIndex=new ss(e.fields),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}destroy(){this._frameTask=De(this._frameTask),this.clearCache(),Ge(this._geometryQueryCache),this._changeHandle=De(this._changeHandle),Ge(this.fieldsIndex)}get featureAdapter(){return this.featureStore.featureAdapter}get fullExtent(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:W(this.spatialReference)}:null}get timeExtent(){return this.timeInfo?(this._timeExtent||(this._timeExtent=Ds(this.timeInfo,this.featureStore)),this._timeExtent):null}clearCache(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null}async executeQuery(e={},t){let i,s=B(e);try{s=await this._schedule(()=>Z(s,this.definitionExpression,this.spatialReference),t),s=await this._reschedule(()=>this._checkQuerySupport(s),t),i=await this._reschedule(()=>this._executeGeometryQuery(s,t),t),i=await this._reschedule(()=>i.executeAggregateIdsQuery(s),t),i=await this._reschedule(()=>i.executeObjectIdsQuery(s),t),i=await this._reschedule(()=>i.executeTimeQuery(s),t),i=await this._reschedule(()=>i.executeAttributesQuery(s),t)}catch(a){if(a!==Q)throw a;i=new E([],null,this)}return i.createQueryResponse(s)}async executeQueryForCount(e={},t){let i=B(e);i.returnGeometry=!1,i.returnCentroid=!1,i.outSR=null;try{i=await this._schedule(()=>Z(i,this.definitionExpression,this.spatialReference),t),i=await this._reschedule(()=>this._checkQuerySupport(i),t);let s=await this._reschedule(()=>this._executeGeometryQuery(i,t),t);return s=await this._reschedule(()=>s.executeAggregateIdsQuery(i),t),s=await this._reschedule(()=>s.executeObjectIdsQuery(i),t),s=await this._reschedule(()=>s.executeTimeQuery(i),t),s=await this._reschedule(()=>s.executeAttributesQuery(i),t),s.createQueryResponseForCount(i)}catch(s){if(s!==Q)throw s;return 0}}async executeQueryForExtent(e={},t){let i,s=B(e);const a=s.outSR;try{s=await this._schedule(()=>Z(s,this.definitionExpression,this.spatialReference),t),s=await this._reschedule(()=>this._checkQuerySupport(s),t),s.returnGeometry=!0,s.returnCentroid=!1,s.outSR=null,i=await this._reschedule(()=>this._executeGeometryQuery(s,t),t),i=await this._reschedule(()=>i.executeAggregateIdsQuery(s),t),i=await this._reschedule(()=>i.executeObjectIdsQuery(s),t),i=await this._reschedule(()=>i.executeTimeQuery(s),t),i=await this._reschedule(()=>i.executeAttributesQuery(s),t);const n=i.size;if(!n)return{count:n,extent:null};is(P,rs),this.featureStore.forEachBounds(i.items,l=>as(P,l),pi);const o={xmin:P[0],ymin:P[1],xmax:P[3],ymax:P[4],spatialReference:W(this.spatialReference)};this.hasZ&&isFinite(P[2])&&isFinite(P[5])&&(o.zmin=P[2],o.zmax=P[5]);const u=q(o,i.spatialReference,a);if(u.spatialReference=W(a||this.spatialReference),u.xmax-u.xmin==0){const l=Ie(u.spatialReference);u.xmin-=l,u.xmax+=l}if(u.ymax-u.ymin==0){const l=Ie(u.spatialReference);u.ymin-=l,u.ymax+=l}if(this.hasZ&&u.zmin!=null&&u.zmax!=null&&u.zmax-u.zmin==0){const l=Ie(u.spatialReference);u.zmin-=l,u.zmax+=l}return{count:n,extent:u}}catch(n){if(n===Q)return{count:0,extent:null};throw n}}async executeQueryForIds(e={},t){return this.executeQueryForIdSet(e,t).then(i=>Array.from(i))}async executeQueryForIdSet(e={},t){let i,s=B(e);s.returnGeometry=!1,s.returnCentroid=!1,s.outSR=null;try{s=await this._schedule(()=>Z(s,this.definitionExpression,this.spatialReference),t),s=await this._reschedule(()=>this._checkQuerySupport(s),t),i=await this._reschedule(()=>this._executeGeometryQuery(s,t),t),i=await this._reschedule(()=>i.executeAggregateIdsQuery(s),t),i=await this._reschedule(()=>i.executeObjectIdsQuery(s),t),i=await this._reschedule(()=>i.executeTimeQuery(s),t),i=await this._reschedule(()=>i.executeAttributesQuery(s),t);const a=i.items,n=new Set;return await this._reschedule(()=>{for(const o of a)n.add(i.featureAdapter.getObjectId(o))},t),n}catch(a){if(a===Q)return new Set;throw a}}async executeQueryForSnapping(e,t){const{point:i,distance:s,types:a}=e;if(a===0)return{candidates:[]};const n=await this._reschedule(()=>this._checkQuerySupport(e.query),t),o=!M(i.spatialReference,this.spatialReference);o&&await Y(i.spatialReference,this.spatialReference);const u=typeof s=="number"?s:s.x,l=typeof s=="number"?s:s.y,c={xmin:i.x-u,xmax:i.x+u,ymin:i.y-l,ymax:i.y+l,spatialReference:i.spatialReference},h=o?q(c,this.spatialReference):c;if(!h)return{candidates:[]};const f=(await Ee(Re(i),null,{signal:t}))[0],_=(await Ee(Re(h),null,{signal:t}))[0];if(v(f)||v(_))return{candidates:[]};let d=new E(this._searchFeatures(this._getQueryBBoxes(_.toJSON())),null,this);d=await this._reschedule(()=>d.executeObjectIdsQuery(n),t),d=await this._reschedule(()=>d.executeTimeQuery(n),t),d=await this._reschedule(()=>d.executeAttributesQuery(n),t);const x=f.toJSON(),m=o?q(x,this.spatialReference):x,g=o?Math.max(h.xmax-h.xmin,h.ymax-h.ymin)/2:s;return d.createSnappingResponse(Ve(ae({},e),{point:m,distance:g}),i.spatialReference)}async executeQueryForLatestObservations(e={},t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new R(k,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});let i,s=B(e);try{s=await this._schedule(()=>Z(s,this.definitionExpression,this.spatialReference),t),s=await this._reschedule(()=>this._checkQuerySupport(s),t),i=await this._reschedule(()=>this._executeGeometryQuery(s,t),t),i=await this._reschedule(()=>i.executeAggregateIdsQuery(s),t),i=await this._reschedule(()=>i.executeObjectIdsQuery(s),t),i=await this._reschedule(()=>i.executeTimeQuery(s),t),i=await this._reschedule(()=>i.executeAttributesQuery(s),t),i=await this._reschedule(()=>i.filterLatest(),t)}catch(a){if(a!==Q)throw a;i=new E([],null,this)}return i.createQueryResponse(s)}async executeQueryForSummaryStatistics(e={},t,i){const{field:s,normalizationField:a,valueExpression:n}=t;return(await this._getQueryEngineResultForStats(e,{field:s,normalizationField:a,valueExpression:n},i)).createSummaryStatisticsResponse(e,t)}async executeQueryForUniqueValues(e={},t,i){const{field:s,valueExpression:a}=t;return(await this._getQueryEngineResultForStats(e,{field:s,valueExpression:a},i)).createUniqueValuesResponse(e,t)}async executeQueryForClassBreaks(e={},t,i){const{field:s,normalizationField:a,valueExpression:n}=t;return(await this._getQueryEngineResultForStats(e,{field:s,normalizationField:a,valueExpression:n},i)).createClassBreaksResponse(e,t)}async executeQueryForHistogram(e={},t,i){const{field:s,normalizationField:a,valueExpression:n}=t;return(await this._getQueryEngineResultForStats(e,{field:s,normalizationField:a,valueExpression:n},i)).createHistogramResponse(e,t)}async _schedule(e,t){return F(this._frameTask)?this._frameTask.schedule(e,t):e(me)}async _reschedule(e,t){return F(this._frameTask)?this._frameTask.reschedule(e,t):e(me)}_getAll(){if(!this._allItems){const e=[];this.featureStore.forEach(t=>e.push(t)),this._allItems=new E(e,null,this)}return this._allItems}async _executeGeometryQuery(e,t){const{geometry:i,outSR:s,spatialRel:a,returnGeometry:n,returnCentroid:o}=e,u=n||o,l=X(s)&&!M(this.spatialReference,s),c=this._geometryQueryCache?l&&u?JSON.stringify({geometry:i,spatialRelationship:a,outSpatialReference:s}):JSON.stringify({geometry:i,spatialRelationship:a}):null;if(c){const m=this._geometryQueryCache.get(c);if(!ns(m))return m}const h=async m=>{if(l&&u){const g=await m.project(s);return c&&this._geometryQueryCache.put(c,g,g.size||1),g}return c&&this._geometryQueryCache.put(c,m,m.size||1),m};if(!i)return h(this._getAll());const f=this.featureAdapter;if(a==="esriSpatialRelDisjoint"){const m=this._searchFeatures(this._getQueryBBoxes(i));if(!m.length)return h(this._getAll());let g,S;const T=new Set;for(const I of m)T.add(f.getObjectId(I));await this._reschedule(()=>{let I=0;g=new Array(T.size),this.featureStore.forEach(y=>g[I++]=y),S=T},t);const w=await this._reschedule(async()=>{const I=await Xe(a,i,this.geometryType,this.hasZ,this.hasM),y=$=>!S.has(f.getObjectId($))||I(f.getGeometry($));return new E(await this._runSpatialFilter(g,y,t),i,this)},t);return h(w)}const _=this._searchFeatures(this._getQueryBBoxes(i));if(!_.length){const m=new E([],i,this);return c&&this._geometryQueryCache.put(c,m,m.size||1),m}if(this._canExecuteSoloPass(i,e))return h(new E(_,i,this));const d=await Xe(a,i,this.geometryType,this.hasZ,this.hasM),x=await this._runSpatialFilter(_,m=>d(f.getGeometry(m)),t);return h(new E(x,i,this))}async _runSpatialFilter(e,t,i){if(!t)return e;if(v(this._frameTask))return e.filter(o=>t(o));let s=0;const a=new Array,n=async o=>{for(;s<e.length;){const u=e[s++];t(u)&&(a.push(u),o.madeProgress()),o.done&&await this._reschedule(l=>n(l),i)}};return this._reschedule(o=>n(o),i).then(()=>a)}_canExecuteSoloPass(e,t){const{geometryType:i}=this,{spatialRel:s}=t;return Ke(e)&&(s==="esriSpatialRelEnvelopeIntersects"||i==="esriGeometryPoint"&&(s==="esriSpatialRelIntersects"||s==="esriSpatialRelContains"||s==="esriSpatialRelWithin"))}_getQueryBBoxes(e){if(Ke(e)){if(te(e))return[Ue(e.xmin,e.ymin,e.xmax,e.ymax)];if(he(e))return e.rings.map(t=>Ue(Math.min(t[0][0],t[2][0]),Math.min(t[0][1],t[2][1]),Math.max(t[0][0],t[2][0]),Math.max(t[0][1],t[2][1])))}return[os(us(),e)]}_searchFeatures(e){for(const s of e)this.featureStore.forEachInBounds(s,a=>{ue.add(a)});const t=new Array(ue.size);let i=0;return ue.forEach(s=>t[i++]=s),ue.clear(),t}async _checkStatisticsSupport(e,t){if(e.distance<0||e.geometryPrecision!=null||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new R(k,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsParamsSupport(t),Je(e,this.geometryType,this.spatialReference),Y(this.spatialReference,e.outSR)]).then(()=>e)}async _checkStatisticsParamsSupport(e){let t=[];if(e.valueExpression){const{arcadeUtils:i}=await ct();t=i.extractFieldNames(e.valueExpression)}if(e.field&&t.push(e.field),e.normalizationField&&t.push(e.normalizationField),!t.length)throw new R(k,"params should have at least a field or valueExpression",{params:e});N(this.fieldsIndex,t,"params contains missing fields")}async _checkQuerySupport(e){if(e.distance<0||e.geometryPrecision!=null||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new R(k,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),Je(e,this.geometryType,this.spatialReference),Y(this.spatialReference,e.outSR)]).then(()=>e)}_checkAttributesQuerySupport(e){const{outFields:t,orderByFields:i,returnDistinctValues:s,outStatistics:a}=e,n=a?a.map(o=>o.outStatisticFieldName&&o.outStatisticFieldName.toLowerCase()):[];if(i&&i.length>0){const o=" asc",u=" desc",l=i.map(c=>{const h=c.toLowerCase();return h.indexOf(o)>-1?h.split(o)[0]:h.indexOf(u)>-1?h.split(u)[0]:c}).filter(c=>n.indexOf(c)===-1);N(this.fieldsIndex,l,"orderByFields contains missing fields")}if(t&&t.length>0)N(this.fieldsIndex,t,"outFields contains missing fields");else if(s)throw new R(k,"outFields should be specified for returnDistinctValues",{query:e});Os(this.fieldsIndex,e.where)}async _checkStatisticsQuerySupport(e){const{outStatistics:t,groupByFieldsForStatistics:i,having:s}=e,a=i&&i.length,n=t&&t.length;if(s){if(!a||!n)throw new R(k,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});ks(this.fieldsIndex,s,t)}if(n){if(!di(t))return;const o=t.map(u=>u.onStatisticField);N(this.fieldsIndex,o,"onStatisticFields contains missing fields"),a&&N(this.fieldsIndex,i,"groupByFieldsForStatistics contains missing fields");for(const u of t){const{onStatisticField:l,statisticType:c}=u;if((c==="percentile_disc"||c==="percentile_cont")&&"statisticParameters"in u){const{statisticParameters:h}=u;if(!h)throw new R(k,"statisticParamters should be set for percentile type",{definition:u,query:e})}else if(c!=="count"&&l&&Ns(l,this.fieldsIndex))throw new R(k,"outStatistics contains non-numeric fields",{definition:u,query:e})}}}async _getQueryEngineResultForStats(e={},t,i){let s;e=B(e);try{e=await this._schedule(()=>Z(e,this.definitionExpression,this.spatialReference),i),e=await this._reschedule(()=>this._checkStatisticsSupport(e,t),i),s=await this._reschedule(()=>this._executeGeometryQuery(e,i),i),s=await this._reschedule(()=>s.executeAggregateIdsQuery(e),i),s=await this._reschedule(()=>s.executeObjectIdsQuery(e),i),s=await this._reschedule(()=>s.executeTimeQuery(e),i),s=await this._reschedule(()=>s.executeAttributesQuery(e),i)}catch(a){if(a!==Q)throw a;s=new E([],null,this)}return s}}const pi=dt(),P=dt();export{vi as B,$i as C,Pi as L,Zs as Z,Xe as a,Y as f,q as g,Gs as n,bi as q,He as s,Ai as v};
