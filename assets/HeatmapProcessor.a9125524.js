var D=Object.defineProperty,G=Object.defineProperties;var L=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var E=(t,e,r)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,I=(t,e)=>{for(var r in e||(e={}))P.call(e,r)&&E(t,r,e[r]);if(F)for(var r of F(e))V.call(e,r)&&E(t,r,e[r]);return t},K=(t,e)=>G(t,L(e));import{_ as j,a0 as q,ei as z,E as H,ev as v}from"./vendor.b8b0b9ef.js";import{o as W}from"./definitions.fec13401.js";import{p as Y,l as d}from"./tileUtils.3a57b37a.js";import"./TileKey.7b485699.js";(()=>{if(!("document"in globalThis))return()=>null;const t=document.createElement("canvas"),e=t.getContext("2d"),r=512;return t.height=r,t.width=1,a=>{e.clearRect(0,0,1,t.height);const s=e.createLinearGradient(0,0,0,t.height);for(const{ratio:i,color:o}of a.colorStops)s.addColorStop(Math.max(i,.001),`rgba(${o[0]}, ${o[1]}, ${o[2]}, ${o[3]})`);return e.fillStyle=s,e.fillRect(0,0,1,t.height),e.getImageData(0,0,1,t.height).data}})();function B(t,e,r,a){const{blurRadius:s,fieldOffset:i,field:o}=e,p=new Float64Array(r*a),y=J(s),h=Math.round(3*s);let c,u=Number.NEGATIVE_INFINITY;const m=Q(o,i),g=new Set;for(const S of t){const f=S.getCursor();for(;f.next();){const M=f.getObjectId();if(g.has(M))continue;g.add(M);const n=f.readLegacyPointGeometry(),T=128;if(n.x<-T||n.x>=r+T||n.y<-T||n.y>a+T)continue;const C=+m(f),b=Math.round(n.x)-h,k=Math.round(n.y)-h,O=Math.max(0,b),U=Math.max(0,k),$=Math.min(a,Math.round(n.y)+h),R=Math.min(r,Math.round(n.x)+h);for(let w=U;w<$;w++){const A=y[w-k];for(let x=O;x<R;x++){const N=y[x-b];c=p[w*r+x]+=A*N*C,c>u&&(u=c)}}}}return{matrix:p.buffer,max:u}}function J(t){const e=Math.round(3*t),r=2*t*t,a=new Float64Array(2*e+1);for(let s=0;s<=a.length;s++)a[s]=Math.exp(-((s-e)**2)/r)/Math.sqrt(2*Math.PI)*(t/2);return a}function Q(t,e){return t!=null?typeof e=="string"?r=>-1*+r.readAttribute(t):r=>+r.readAttribute(t)+e:r=>1}class l{constructor(e,r){this.offset=e,this.extent=r}}function X(t){const e=t.key,r=new Map,a=256,s=W,i=t.tileInfoView.tileInfo.isWrappable;return r.set(d(e,-1,-1,i).id,new l([-s,-s],[s-a,s-a,s,s])),r.set(d(e,0,-1,i).id,new l([0,-s],[0,s-a,s,s])),r.set(d(e,1,-1,i).id,new l([s,-s],[0,s-a,a,s])),r.set(d(e,-1,0,i).id,new l([-s,0],[s-a,0,s,s])),r.set(d(e,1,0,i).id,new l([s,0],[0,0,a,s])),r.set(d(e,-1,1,i).id,new l([-s,s],[s-a,0,s,a])),r.set(d(e,0,1,i).id,new l([0,s],[0,0,s,a])),r.set(d(e,1,1,i).id,new l([s,s],[0,0,a,a])),r}let _=class extends Y{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(t,e){const r=e.schema.processors[0];r.type==="heatmap"&&z(this._schema,r)&&(t.mesh=!0,this._schema=r)}onTileUpdate(t){for(const e of t.removed)this._tileKeyToFeatureSets.delete(e.key.id)}onTileClear(t){const e={clear:!0};return this._tileKeyToFeatureSets.delete(t.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:t.id,data:e})}async onTileMessage(t,e,r){this._tileKeyToFeatureSets.has(t.key.id)||this._tileKeyToFeatureSets.set(t.key.id,new Map);const a=this._tileKeyToFeatureSets.get(t.key.id);if(H(e.addOrUpdate)&&e.addOrUpdate.hasFeatures&&a.set(e.addOrUpdate.instance,e),e.end){const s=[],i=X(t);this._tileKeyToFeatureSets.forEach((h,c)=>{if(c===t.key.id)h.forEach(u=>v(u.addOrUpdate,m=>s.push(m)));else if(i.has(c)){const u=i.get(c),[m,g]=u.offset;h.forEach(S=>v(S.addOrUpdate,f=>{const M=f.transform(m,g,1,1);s.push(M)}))}});const o=B(s,this._schema.mesh,512,512),p={tileKey:t.key.id,intensityInfo:o},y=[o.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",p,K(I({},r),{transferList:y}))}}onTileError(t,e,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:t.id,error:e},r)}};_=j([q("esri.views.2d.layers.features.processors.HeatmapProcessor")],_);const ae=_;export{ae as default};
